#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
THK Backup â€“ ì‹¤ì‹œê°„(ë”œë ˆì´ 0â€¯h) ë°ì´í„°ë¥¼ DBì—ì„œ ê°€ì ¸ì™€ Excelì— ì €ì¥
ì¶”ê°€ ê¸°ëŠ¥
  â€¢ ì½˜ì†”ì— â€œNPW_DACUHDP8KLP (NPW ID) THK ì²«ì¥ (SLOT ID : xxx) - 25ê°œ THK ì…ë ¥â€
    ì™€ ê°™ì€ í˜•íƒœë¡œ ê° ì›¨ì´í¼Â·ìŠ¬ë¡¯ ì •ë³´ë¥¼ ì¶œë ¥
  â€¢ HBMHDP8K, GOF, RI ë“± ëª¨ë“  ì¡°í•©ì— ì ìš©
"""

import sys
import traceback
import re
from pathlib import Path
from typing import List, Optional, Dict, Tuple
from datetime import datetime
import pandas as pd
import xlwings as xw
import bigdataquery as bdq   # AD ë¡œê·¸ì¸ í•„ìš”
from tqdm import tqdm

# ----------------------------------------------------------------------
# â‘  íŒŒì¼Â·í´ë” ê²½ë¡œ
# ----------------------------------------------------------------------
EXCEL_SRC = Path.home() / "Desktop" / "PHDP_DRAM_BU_SHEET.xlsx"
EXCEL_DST = Path.home() / "Desktop" / "ë°±ì—…ì™„ë£Œ.xlsx"

# ----------------------------------------------------------------------
# â‘¡ ì‚¬ìš©ì UI (ì¥ë¹„Â·ì±”ë²„Â·ì»¨í…Œì´ë„ˆÂ·FOUPÂ·SLOT)
# ----------------------------------------------------------------------
def _to_upper_list(inp: str, allowed: List[str]) -> List[str]:
    """ì‰¼í‘œâ€‘êµ¬ë¶„ ë¬¸ìì—´ì„ ëŒ€ë¬¸ìë¡œ ì •ê·œí™”í•˜ê³  í—ˆìš©ê°’ë§Œ ë‚¨ê¹€"""
    if not inp:
        return []
    return [x.upper() for x in inp.split(",") if x.strip().upper() in allowed]

def select_equipment_and_chamber() -> Tuple[
        List[str], List[str], List[str], List[int]]:
    """
    ì½˜ì†” UI ë¡œ ì¥ë¹„, ì±”ë²„, ì»¨í…Œì´ë„ˆ(FOUP), SLOT ë²ˆí˜¸ë¥¼ ì„ íƒí•œë‹¤.
    ë°˜í™˜ê°’ : (equipment, chambers, containers, slot_numbers)
    """
    available_equipment = [
        "TAHP851", "TAHP852", "TAHP853",
        "TAHP854", "TAHP855", "TAHP856", "TAHP857"
    ]
    available_chambers = ["A", "B", "D"]

    print("=" * 50)
    print("ğŸ­ THK Backup â€“ ì‹¤ì‹œê°„(ë”œë ˆì´ ì—†ìŒ) ì„¤ì •")
    print("=" * 50)

    # â”€â”€ ì¥ë¹„ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print(f"\nğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ì¥ë¹„: {', '.join(available_equipment)}")
    equipment_input = input(
        "ğŸ”§ ì‚¬ìš©í•  ì¥ë¹„ë¥¼ ì…ë ¥ (ì‰¼í‘œ êµ¬ë¶„, ì˜ˆ: TAHP857 í˜¹ì€ TAHP856,TAHP857): "
    ).strip()
    selected_eqp = _to_upper_list(equipment_input, available_equipment)
    if not selected_eqp:
        selected_eqp = ["TAHP857"]
    print(f"   â†’ ì„ íƒëœ ì¥ë¹„: {selected_eqp}")

    # â”€â”€ ì±”ë²„ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print(f"\nğŸ  ì‚¬ìš© ê°€ëŠ¥í•œ ì±”ë²„: {', '.join(available_chambers)}")
    chamber_input = input(
        "ğŸ”§ ì‚¬ìš©í•  ì±”ë²„ë¥¼ ì…ë ¥ (ì‰¼í‘œ êµ¬ë¶„, ì˜ˆ: A í˜¹ì€ A,B): "
    ).strip()
    selected_ch = _to_upper_list(chamber_input, available_chambers)
    if not selected_ch:
        selected_ch = ["A"]
    print(f"   â†’ ì„ íƒëœ ì±”ë²„: {selected_ch}")

    # â”€â”€ ì»¨í…Œì´ë„ˆ(FOUP) ì„ íƒ (ì˜µì…˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    container_input = input(
        "\nğŸ”§(ì„ íƒ) ì»¨í…Œì´ë„ˆ ID(FOUP) ë¥¼ ì‰¼í‘œ êµ¬ë¶„ ì…ë ¥ (ì˜ˆ: C001,C002) â†’ ì…ë ¥ ì—†ìœ¼ë©´ ì „ì²´ ì¡°íšŒ: "
    ).strip()
    selected_cont = [c.strip() for c in container_input.split(",")] if container_input else []
    print(f"   â†’ ì„ íƒëœ ì»¨í…Œì´ë„ˆ(FOUP): {selected_cont if selected_cont else 'ì „ì²´'}")

    # â”€â”€ SLOT ë²ˆí˜¸ ì„ íƒ (ì˜µì…˜) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    slot_input = input(
        "\nğŸ”§(ì„ íƒ) SLOT ë²ˆí˜¸ë¥¼ ì‰¼í‘œ êµ¬ë¶„ ì…ë ¥ (ì˜ˆ: 1,2,3) â†’ ì…ë ¥ ì—†ìœ¼ë©´ ì „ì²´ ì¡°íšŒ: "
    ).strip()
    if slot_input:
        selected_slots = [
            int(s) for s in slot_input.split(",") if s.strip().isdigit()
        ]
    else:
        selected_slots = []   # ì „ì²´ ì¡°íšŒ
    print(f"   â†’ ì„ íƒëœ SLOT ë²ˆí˜¸: {selected_slots if selected_slots else 'ì „ì²´'}")
    print("\n" + "=" * 50)

    return selected_eqp, selected_ch, selected_cont, selected_slots

# ----------------------------------------------------------------------
# â‘¢ DB ì¡°íšŒ (ì‹¤ì‹œê°„ ì¡°ì¸, ë”œë ˆì´ ì—†ìŒ)
# ----------------------------------------------------------------------
def fetch_raw_data(
    days: int = 7,
    equipment_ids: List[str] | None = None,
    chamber_ids: List[str] | None = None,
    container_ids: List[str] | None = None,
    slot_numbers: List[int] | None = None,
) -> Tuple[pd.DataFrame, Optional[pd.Timestamp]]:
    """
    ìµœê·¼ `days` ì¼ê°„ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ ì¡°ì¸ ì¿¼ë¦¬ë¡œ ê°€ì ¸ì˜¨ë‹¤.
    ë°˜í™˜ê°’ : (DataFrame, latest_tkin_time)
    """
    # 1ï¸âƒ£ AD ë¡œê·¸ì¸
    try:
        bdq.getData("SELECT 1")
    except Exception:
        print("â–¶ AD ë¡œê·¸ì¸ í•„ìš” â†’ í„°ë¯¸ë„ì— ê³„ì •Â·ë¹„ë°€ë²ˆí˜¸ ì…ë ¥")
        bdq.login()

    # 2ï¸âƒ£ ê¸°ë³¸ê°’ ì„¤ì •
    if equipment_ids is None:
        equipment_ids = ["TAHP857"]
    if chamber_ids is None:
        chamber_ids = ["A"]
    if container_ids is None:
        container_ids = []          # ì „ì²´ ì¡°íšŒ
    if slot_numbers is None:
        slot_numbers = []          # ì „ì²´ ì¡°íšŒ

    # 3ï¸âƒ£ INâ€‘ì ˆ ë¬¸ìì—´ (ì´ë¯¸ ê²€ì¦ëœ ë¦¬ìŠ¤íŠ¸ì´ë¯€ë¡œ ì•ˆì „)
    equip_str = "','".join(equipment_ids)
    chamber_str = "','".join(chamber_ids)
    container_str = "','".join(container_ids)

    # 4ï¸âƒ£ ì‹œê°„ êµ¬ê°„ ì •ì˜ (ë”œë ˆì´ ì—†ìŒ)
    start_expr = f"DATE_SUB(NOW(), INTERVAL {days} DAY)"
    end_expr = "NOW()"

    # 5ï¸âƒ£ SLOT í•„í„° (ì˜µì…˜)
    slot_filter = ""
    if slot_numbers:
        slot_list = ",".join(map(str, slot_numbers))
        slot_filter = f"AND A.prc_slot_id IN ({slot_list})"

    # 6ï¸âƒ£ ì‹¤ì‹œê°„ ì¡°ì¸ ì¿¼ë¦¬ â€“ tkin_time í¬í•¨
    query = f"""
    SELECT
        A.prc_tkin_time,
        A.step_seq,
        A.eqp_id,
        A.tkin_time,                     -- ì›ë³¸ tkin_time
        A.tkin_time          AS metro_tkin_time,
        A.container_id,
        A.prc_eqp_id,
        A.chamber_ids,
        A.prc_ppid,
        A.shelf_id,
        A.npw_wafer_id,
        A.prc_slot_id,                   -- SLOT ë²ˆí˜¸ (ìˆì„ ê²½ìš°)
        CONCAT(A.container_id, '_', A.shelf_id) AS npw,
        B.item_id,
        B.subitem_id,
        B.value
    FROM
    ( SELECT
        npw_wafer_id,
        step_seq,
        eqp_id,
        tkin_time,
        container_id,
        prc_eqp_id,
        prc_ppid,
        shelf_id,
        prc_tkin_time,
        dcol_time,
        chamber_id_list AS chamber_ids,
        prc_slot_id
      FROM yms_me_main_rt.sor_trk_fab_met_npw
      WHERE dcol_time BETWEEN {start_expr} AND {end_expr}
        AND (line_id LIKE 'P%' OR line_id LIKE 'K%')
        AND SUBSTR(line_id,3,1) <> 'R'
        AND prc_tkin_time BETWEEN {start_expr} AND {end_expr}
        AND prc_eqp_id IN ('{equip_str}')
        AND chamber_id_list IN ('{chamber_str}')
        {"AND container_id IN ('" + container_str + "')" if container_str else ""}
        {slot_filter}
        AND shelf_id IS NOT NULL
    ) A
    LEFT JOIN
    ( SELECT
        npw_wafer_id,
        step_seq,
        item_id,
        sub_item_id   AS subitem_id,
        item_value    AS value,
        dcol_time
      FROM yms_me_main_rt.sor_trk_fab_met_npw_msr
      WHERE dcol_time BETWEEN {start_expr} AND {end_expr}
        AND ( SUBSTR(item_id,1,2) IN ('TH','RI','RK','GO','B1','P1')
              OR item_id IN ('WARPCF_X','BOW1_1') )
        AND SUBSTR(sub_item_id,1,1) IN ('S','A','R')
        AND sub_item_id NOT IN ('STD','SLOTID','SKEW')
    ) B
      ON A.npw_wafer_id = B.npw_wafer_id
     AND A.dcol_time    = B.dcol_time
    WHERE B.item_id IS NOT NULL;
    """

    print("\nâ–¶ ë°ì´í„° ì¡°íšŒ ì¤‘â€¦")
    df = bdq.getData(query)                      # pandas DataFrame ë°˜í™˜
    print(f"âœ… ì¡°íšŒì™„ë£Œ : {len(df)} rows, {len(df.columns)} columns")

    # 7ï¸âƒ£ Timestamp ì»¬ëŸ¼ì„ UTC datetime ë¡œ ë³€í™˜
    for col in ("prc_tkin_time", "dcol_time"):
        if col in df.columns:
            df[col] = pd.to_datetime(df[col], errors="coerce")
            if df[col].dt.tz is None:
                df[col] = df[col].dt.tz_localize("UTC")

    # 8ï¸âƒ£ ì¡°íšŒ ì‹œì (UTC) ì¶”ê°€
    fetch_ts = datetime.utcnow().replace(tzinfo=pd.Timestamp.utcnow().tz)
    df["fetch_timestamp"] = fetch_ts

    # 9ï¸âƒ£ ìµœì‹  tkin_time(UTC) í™•ë³´
    latest_tkin_time: Optional[pd.Timestamp] = None
    if "tkin_time" in df.columns:
        df["tkin_time"] = pd.to_datetime(df["tkin_time"], errors="coerce")
        if df["tkin_time"].dt.tz is None:
            df["tkin_time"] = df["tkin_time"].dt.tz_localize("UTC")
        latest_tkin_time = df["tkin_time"].max()

    # 10ï¸âƒ£ ì½˜ì†”ì— ì„ íƒ ì˜µì…˜ ìš”ì•½
    print("\n--- ì„ íƒëœ ì¡°íšŒ ì˜µì…˜ ìš”ì•½ ---")
    print(f"ì¥ë¹„(equipment)          : {equipment_ids}")
    print(f"ì±”ë²„(chamber)           : {chamber_ids}")
    print(f"FOUP(ì»¨í…Œì´ë„ˆ)          : {container_ids if container_ids else 'ì „ì²´'}")
    print(f"SLOT ë²ˆí˜¸               : {slot_numbers if slot_numbers else 'ì „ì²´'}")
    print(f"ì¡°íšŒ ì‹œì (fetch_timestamp) : {fetch_ts}")
    print(f"ìµœì‹  tkin_time               : {latest_tkin_time}")
    print("-" * 40)

    return df, latest_tkin_time

# ----------------------------------------------------------------------
# â‘£ ì›¨ì´í¼ ID ì •ë ¬ìš© í—¬í¼ â€“ ëì— ìˆëŠ” ìˆ«ì(ì  í¬í•¨) ì¶”ì¶œ
# ----------------------------------------------------------------------
def _wafer_sort_key(wafer_id: str):
    """
    ë¬¸ìì—´ì—ì„œ **ëì— ìˆëŠ” ìˆ«ì(ë˜ëŠ” ì†Œìˆ˜ì  í¬í•¨)** ë¥¼ ì¶”ì¶œí•´
    ì •ìˆ˜/ì‹¤ìˆ˜ ë¡œ ë³€í™˜ í›„ ì •ë ¬.
    ìˆ«ìë¥¼ ì°¾ì§€ ëª»í•˜ë©´ ë¬¸ìì—´ ìì²´ë¥¼ ë°˜í™˜í•´ ì‚¬ì „ì‹ ì •ë ¬.
    """
    match = re.search(r"(\d+(?:\.\d+)?)\s*$", str(wafer_id))
    if match:
        num_str = match.group(1)
        try:
            return float(num_str) if "." in num_str else int(num_str)
        except ValueError:
            pass
    return wafer_id

# ----------------------------------------------------------------------
# â‘¤ ìµœì‹  ì›¨ì´í¼ ë°ì´í„° ì¶”ì¶œ (ë‘ ì›¨ì´í¼ê¹Œì§€)
# ----------------------------------------------------------------------
def get_latest_wafer_data(
    df: pd.DataFrame,
    prc_ppid: str,
    item_ids: List[str],
    subitem_pattern: str,
    expected_count: int,
    step_seq_list: List[str],
    strict: bool = True,
) -> Tuple[List[List[Optional[float]]], List[str]]:
    """
    ë°˜í™˜ê°’ : (values_per_wafer, wafer_ids)
    - `values_per_wafer` : ë‘ ì›¨ì´í¼ ê°ê°ì— ëŒ€í•œ value ë¦¬ìŠ¤íŠ¸
    - `wafer_ids`        : í•´ë‹¹ ì›¨ì´í¼ë¥¼ êµ¬ë¶„í•  ID (SLOT ID í˜¹ì€ npw_wafer_id)
    """
    # 1ï¸âƒ£ í•„í„°ë§ (ê³µì •Â·ì•„ì´í…œÂ·subitemÂ·step_seq)
    mask = (
        (df["prc_ppid"] == prc_ppid)
        & (df["item_id"].isin(item_ids))
        & (df["subitem_id"].str.fullmatch(subitem_pattern))
        & (df["step_seq"].isin(step_seq_list))
    )
    filtered = df.loc[mask].copy()
    if filtered.empty:
        print(
            f"âš ï¸ {prc_ppid} {item_ids} (step_seq={step_seq_list}) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
        )
        return [[], []], []

    print(
        f"{prc_ppid} {item_ids} (step_seq={step_seq_list}): {len(filtered)} rows ë°œê²¬"
    )

    # 2ï¸âƒ£ ìµœì‹  prc_tkin_time í™•ë³´
    latest_time = filtered["prc_tkin_time"].max()
    latest = filtered[filtered["prc_tkin_time"] == latest_time].copy()
    print(f"  ìµœì‹  prc_tkin_time : {latest_time} ({len(latest)} rows)")

    # 3ï¸âƒ£ ì›¨ì´í¼ êµ¬ë¶„ ì»¬ëŸ¼ ì„ íƒ
    if "prc_slot_id" in latest.columns:
        slot_col = "prc_slot_id"
    elif "npw_wafer_id" in latest.columns:
        slot_col = "npw_wafer_id"
        print("   â†’ prc_slot_id ê°€ ì—†ìœ¼ë¯€ë¡œ npw_wafer_id ë¡œ ì›¨ì´í¼ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.")
    else:
        print("âš ï¸ ì›¨ì´í¼ë¥¼ êµ¬ë¶„í•  ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤ (prc_slot_id / npw_wafer_id).")
        return [[], []], []

    # 4ï¸âƒ£ ì •ë¦¬ & ë¬¸ìì—´ ë³€í™˜
    if pd.api.types.is_categorical_dtype(latest[slot_col]):
        latest[slot_col] = latest[slot_col].cat.remove_unused_categories()
    latest[slot_col] = latest[slot_col].astype(str)

    # 5ï¸âƒ£ ê·¸ë£¹í•‘
    slot_groups = latest.groupby(slot_col, observed=True)

    # 6ï¸âƒ£ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ìˆ«ì ë¶€ë¶„ì„ ê¸°ì¤€)
    slot_ids = sorted(slot_groups.groups.keys(), key=_wafer_sort_key)
    print(f"  slot_id (ì›¨ì´í¼) ëª©ë¡ (ì˜¤ë¦„ì°¨ìˆœ) : {slot_ids}")

    result_wafers: List[List[Optional[float]]] = []
    wafer_ids: List[str] = []

    for i, slot_id in enumerate(slot_ids[:2]):          # ìµœëŒ€ 2ê°œ ì‚¬ìš©
        wafer = slot_groups.get_group(slot_id).copy()
        print(f"  ì›¨ì´í¼ {i+1} (slot_id={slot_id}) : {len(wafer)} rows")
        wafer_ids.append(slot_id)

        if strict and len(wafer) != expected_count:
            print(
                f"  âš ï¸ strict ëª¨ë“œ: ê¸°ëŒ€ ê°œìˆ˜ {expected_count}ì™€ ë‹¤ë¦„ â†’ {len(wafer)} rows"
            )

        # subitem_id ì—ì„œ ìˆ«ì ì¶”ì¶œ í›„ ì •ë ¬
        wafer["sub_num"] = wafer["subitem_id"].str.extract(r"S(\d+)").astype(int)
        wafer = wafer.sort_values("sub_num")

        # ìˆœì„œëŒ€ë¡œ value ë¥¼ float ë¡œ ë³€í™˜
        values: List[Optional[float]] = []
        for j in range(1, expected_count + 1):
            row = wafer[wafer["sub_num"] == j]
            if not row.empty:
                raw_val = row["value"].iloc[0]
                if pd.isna(raw_val) or raw_val in ("", "NULL"):
                    values.append(None)
                else:
                    try:
                        values.append(float(raw_val))
                    except (ValueError, TypeError):
                        values.append(None)
            else:
                values.append(None)

        valid_cnt = sum(v is not None for v in values)
        print(f"    ìœ íš¨ê°’ {valid_cnt}/{expected_count} ê°œ")
        result_wafers.append(values)

    # ë‘ ë²ˆì§¸ ì›¨ì´í¼ê°€ ì—†ì„ ê²½ìš° ë¹ˆ ë¦¬ìŠ¤íŠ¸Â·ë¹ˆ ID ì¶”ê°€ (í˜•ì‹ ìœ ì§€)
    while len(result_wafers) < 2:
        result_wafers.append([])
        wafer_ids.append("")

    return result_wafers, wafer_ids

# ----------------------------------------------------------------------
# â‘¥ ì½˜ì†”ì— ì›¨ì´í¼ ìš”ì•½ ì¶œë ¥ (ìš”êµ¬ëœ í˜•ì‹)
# ----------------------------------------------------------------------
def print_wafer_summary(
    npw_id: str,
    item_label: str,
    wafer_index: int,
    slot_id: str,
    expected_count: int,
) -> None:
    """
    í˜•ì‹:
    NPW_DACUHDP8KLP (NPW ID) THK ì²«ì¥ (SLOT ID : xxx) - 25ê°œ THK ì…ë ¥
    """
    order = ["ì²«ì¥", "ë‘ë²ˆì§¸ì¥"]
    order_str = order[wafer_index] if wafer_index < len(order) else f"{wafer_index+1}ë²ˆì§¸ì¥"
    print(
        f"{npw_id} ({slot_id}) {item_label} {order_str} (SLOT ID : {slot_id}) - {expected_count}ê°œ {item_label} ì…ë ¥"
    )

# ----------------------------------------------------------------------
# â‘¦ Excel ì— ì“°ê¸° (ì…€ ë§¤í•‘ ì •ì˜ + ì¡°íšŒ ì‹œì  ê¸°ë¡)
# ----------------------------------------------------------------------
def write_to_excel(
    all_data: Dict[str, Dict[str, List[List[Optional[float]]]]],
    src: Path,
    dst: Path,
    fetch_timestamp: datetime,
    tkin_timestamp: Optional[pd.Timestamp] = None,
) -> None:
    """ì „ì²´ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ì •ì˜ëœ ì…€ì— ì„¸ë¡œâ€‘ë°°ì—´í•˜ê³  dst ë¡œ ì €ì¥í•œë‹¤."""
    if not src.is_file():
        raise FileNotFoundError(f"ì›ë³¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {src}")

    cell_mapping = {
        "NPW_DACUHDP8KLP": {
            "THK": ["C89", "D89"],       # THK1_1_TOP (25ê°œ)
            "GOF": ["E89", "F89"],       # GOF1_1 (25ê°œ)
            "RI":  ["G89", None],        # RI1_1_L1 (13ê°œ)
        },
        "HBMHDP8K": {
            "THK": ["H89", "I89"],       # THK1_1_TOP
            "GOF": ["J89", "K89"],       # GOF1_1
        },
    }

    app = xw.App(visible=False)   # ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
    try:
        wb = app.books.open(str(src))
        sht = wb.sheets[0]          # ì²« ë²ˆì§¸ ì‹œíŠ¸ ì‚¬ìš©

        # ---- ì¡°íšŒ ì‹œì  (fetch_timestamp) ê¸°ë¡ ----
        sht.range("A1").value = f"Data fetched (UTC) : {fetch_timestamp}"
        # ---- ìµœì‹  tkin_time ê¸°ë¡ (B1) ----
        if tkin_timestamp is not None:
            sht.range("B1").value = f"Latest tkin_time (UTC) : {tkin_timestamp}"
        else:
            sht.range("B1").value = "Latest tkin_time (UTC) : N/A"

        # ---- ì‹¤ì œ ê²°ê³¼ê°’ ì“°ê¸° ----
        for prc_ppid, items in all_data.items():
            if prc_ppid not in cell_mapping:
                continue
            for item_type, wafer_lists in items.items():
                if item_type not in cell_mapping[prc_ppid]:
                    continue
                cells = cell_mapping[prc_ppid][item_type]
                for wafer_idx, (cell, values) in enumerate(zip(cells, wafer_lists)):
                    if cell is None or not values:
                        continue
                    excel_vals = [v if v is not None else "" for v in values]
                    sht.range(cell).options(transpose=True).value = excel_vals
        wb.save(str(dst))
    except Exception as e:
        print(f"âŒ ì—‘ì…€ ì“°ê¸° ì˜¤ë¥˜: {e}", file=sys.stderr)
        raise
    finally:
        wb.close()
        app.quit()

# ----------------------------------------------------------------------
# â‘§ ë©”ì¸ ì‹¤í–‰ íë¦„
# ----------------------------------------------------------------------
def main() -> None:
    """ì „ì²´ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰"""
    DAYS = 7               # ì¡°íšŒ ê¸°ê°„ (ì¼)
    STRICT = False         # ëˆ„ë½ í—ˆìš© ëª¨ë“œ (True â†’ 25/13 ê°œ ëª¨ë‘ ìˆì–´ì•¼ í•¨)

    try:
        # 1ï¸âƒ£ ì¥ë¹„Â·ì±”ë²„Â·ì»¨í…Œì´ë„ˆÂ·FOUPÂ·SLOT ì„ íƒ
        selected_eqp, selected_ch, selected_cont, selected_slots = select_equipment_and_chamber()

        # 2ï¸âƒ£ DB ì¡°íšŒ (ì‹¤ì‹œê°„ ì¡°ì¸, ë”œë ˆì´ ì—†ìŒ) â†’ ìµœì‹  tkin_time ë°˜í™˜
        print("\nğŸ” DBì—ì„œ ë°ì´í„° ì¡°íšŒ ì¤‘...")
        df, latest_tkin_time = fetch_raw_data(
            days=DAYS,
            equipment_ids=selected_eqp,
            chamber_ids=selected_ch,
            container_ids=selected_cont,
            slot_numbers=selected_slots,
        )
        if df.empty:
            print("âŒ ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return

        # ------------------------------------------------------------------
        # 3ï¸âƒ£ ê° ê³µì •Â·ì•„ì´í…œë³„ ë°ì´í„° ìˆ˜ì§‘ + ì½˜ì†” ìš”ì•½ ì¶œë ¥
        # ------------------------------------------------------------------
        all_data: Dict[str, Dict[str, List[List[Optional[float]]]]] = {}

        # ----- NPW_DACUHDP8KLP -----
        print("\n=== NPW_DACUHDP8KLP ì²˜ë¦¬ ì¤‘ ===")
        npw: Dict[str, List[List[Optional[float]]]] = {}
        # THK
        thk_vals, thk_ids = get_latest_wafer_data(
            df,
            "NPW_DACUHDP8KLP",
            ["THK1_1_TOP"],
            r"S(2[0-5]|1[0-9]|[1-9])",
            25,
            ["SVC_PHDP_THK_20"],
            STRICT,
        )
        npw["THK"] = thk_vals
        for idx, slot in enumerate(thk_ids):
            if slot:
                print_wafer_summary(
                    "NPW_DACUHDP8KLP", "THK", idx, slot, 25
                )
        # GOF
        gof_vals, gof_ids = get_latest_wafer_data(
            df,
            "NPW_DACUHDP8KLP",
            ["GOF1_1"],
            r"S(2[0-5]|1[0-9]|[1-9])",
            25,
            ["SVC_PHDP_THK_20"],
            STRICT,
        )
        npw["GOF"] = gof_vals
        for idx, slot in enumerate(gof_ids):
            if slot:
                print_wafer_summary(
                    "NPW_DACUHDP8KLP", "GOF", idx, slot, 25
                )
        # RI
        ri_vals, ri_ids = get_latest_wafer_data(
            df,
            "NPW_DACUHDP8KLP",
            ["RI1_1_L1"],
            r"S(1[0-3]|[1-9])",
            13,
            ["SVC_PHDP_THK_30"],
            STRICT,
        )
        npw["RI"] = ri_vals
        for idx, slot in enumerate(ri_ids):
            if slot:
                print_wafer_summary(
                    "NPW_DACUHDP8KLP", "RI", idx, slot, 13
                )
        all_data["NPW_DACUHDP8KLP"] = npw

        # ----- HBMHDP8K -----
        print("\n=== HBMHDP8K ì²˜ë¦¬ ì¤‘ ===")
        hbm: Dict[str, List[List[Optional[float]]]] = {}
        # THK
        hbm_thk_vals, hbm_thk_ids = get_latest_wafer_data(
            df,
            "HBMHDP8K",
            ["THK1_1_TOP"],
            r"S(2[0-5]|1[0-9]|[1-9])",
            25,
            ["SVC_PHDP_THK_20"],
            STRICT,
        )
        hbm["THK"] = hbm_thk_vals
        for idx, slot in enumerate(hbm_thk_ids):
            if slot:
                print_wafer_summary(
                    "HBMHDP8K", "THK", idx, slot, 25
                )
        # GOF
        hbm_gof_vals, hbm_gof_ids = get_latest_wafer_data(
            df,
            "HBMHDP8K",
            ["GOF1_1"],
            r"S(2[0-5]|1[0-9]|[1-9])",
            25,
            ["SVC_PHDP_THK_20"],
            STRICT,
        )
        hbm["GOF"] = hbm_gof_vals
        for idx, slot in enumerate(hbm_gof_ids):
            if slot:
                print_wafer_summary(
                    "HBMHDP8K", "GOF", idx, slot, 25
                )
        all_data["HBMHDP8K"] = hbm

        # ------------------------------------------------------------------
        # 4ï¸âƒ£ Excel íŒŒì¼ì— ì“°ê¸° (fetch_timestamp & tkin_timestamp ì „ë‹¬)
        # ------------------------------------------------------------------
        fetch_ts = df["fetch_timestamp"].iloc[0]   # ëª¨ë“  í–‰ì— ë™ì¼
        print("\n=== Excel íŒŒì¼ì— ë°ì´í„° ì“°ëŠ” ì¤‘ ===")
        write_to_excel(
            all_data,
            EXCEL_SRC,
            EXCEL_DST,
            fetch_timestamp=fetch_ts,
            tkin_timestamp=latest_tkin_time,
        )

        print("\nğŸ‰ THK Backup ìë™í™” ì„±ê³µ!")

    except Exception as exc:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {exc}", file=sys.stderr)
        traceback.print_exc()


# ----------------------------------------------------------------------
# ì‹¤í–‰ ì§„ì…ì 
# ----------------------------------------------------------------------
if __name__ == "__main__":
    main()
